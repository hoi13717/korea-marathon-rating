<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ëŸ°ìŠ¤íƒ ë‹¤ë“œ | ëŒ€íšŒ ìƒì„¸ ì •ë³´</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="config.js"></script>
    <script src="navbar.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --main-color: #e91e63; --pro-color: #66cc33; --bg-color: #f0f2f5; }
        body { font-family: 'Pretendard', sans-serif; background-color: var(--bg-color); margin: 0; padding-bottom: 80px; }
        .container { max-width: 800px; margin: 0 auto; padding: 20px 1rem; }

        /* ğŸ“Š ë©”íƒ€í¬ë¦¬í‹± ìŠ¤íƒ€ì¼ ì ìˆ˜ ì„¹ì…˜ */
        .score-row { display: flex; gap: 20px; margin: 25px 0; align-items: center; }
        .score-box { width: 90px; height: 90px; border-radius: 12px; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; font-weight: 900; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .score-box.pro { background: var(--pro-color); }
        .score-box.user { background: var(--main-color); }
        .score-num { font-size: 2.3rem; line-height: 1; }
        .score-label { font-size: 0.65rem; margin-top: 5px; opacity: 0.9; font-weight: 800; }

        /* ğŸ“º ì˜ìƒ ë° ìš”ì•½ ì˜ì—­ */
        .video-container { width: 100%; aspect-ratio: 16 / 9; border-radius: 20px; overflow: hidden; background: #000; box-shadow: 0 10px 30px rgba(0,0,0,0.15); margin-bottom: 25px; }
        .race-summary { background: white; border-radius: 24px; padding: 25px; box-shadow: 0 4px 20px rgba(0,0,0,0.03); line-height: 1.8; color: #444; }

        /* â­ 5ëŒ€ ì§€í‘œ íˆ¬í‘œ ì¹´ë“œ */
        .rating-card { background: white; border-radius: 24px; padding: 25px; margin-top: 30px; box-shadow: 0 4px 20px rgba(0,0,0,0.03); }
        .rating-item { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .rating-label { font-weight: 800; color: #222; font-size: 0.95rem; }
        .rating-select { padding: 10px 15px; border-radius: 12px; border: 1px solid #eee; background: #f9f9f9; font-weight: 800; outline: none; cursor: pointer; }

        .submit-btn { width: 100%; padding: 20px; background: var(--main-color); color: white; border: none; border-radius: 18px; font-weight: 900; font-size: 1.2rem; cursor: pointer; margin-top: 20px; transition: 0.3s; }
        .submit-btn:hover { transform: translateY(-3px); box-shadow: 0 10px 20px rgba(233, 30, 99, 0.2); }
    </style>
</head>
<body>
    <div class="container">
        <div id="loading-view" style="text-align:center; padding:150px 0;">
            <i class="fa-solid fa-spinner fa-spin fa-3x" style="color:#ddd;"></i>
        </div>

        <div id="main-view" style="display:none;">
            <h1 id="race-title" style="font-weight: 900; letter-spacing: -1.5px; margin-bottom: 8px; color:#1a1a1a;"></h1>
            <p id="race-date" style="color: #999; font-weight: 700; margin-bottom: 30px; font-size:0.95rem;"></p>

            <div class="video-container">
                <iframe id="youtube-player" width="100%" height="100%" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
            </div>

            <div class="score-row">
                <div class="score-box pro">
                    <span class="score-num" id="pro-val">-</span>
                    <span class="score-label">PROS</span>
                </div>
                <div style="flex: 1;">
                    <h3 style="margin: 0; font-size: 1.2rem; color: #1a1a1a;">ì „ë¬¸ê°€ ì ìˆ˜</h3>
                    <p style="margin: 3px 0 0; color: #888; font-size: 0.85rem;" id="pro-text">ì¸í”Œë£¨ì–¸ì„œ ê³µì‹ ë¦¬ë·°</p>
                </div>

                <div class="score-box user">
                    <span class="score-num" id="user-val">-</span>
                    <span class="score-label">USERS</span>
                </div>
                <div style="flex: 1; text-align: right;">
                    <h3 style="margin: 0; font-size: 1.2rem; color: #1a1a1a;">ëŸ¬ë„ˆ ì ìˆ˜</h3>
                    <p style="margin: 3px 0 0; color: #888; font-size: 0.85rem;" id="user-count">0ëª…ì˜ í‰ì  ê¸°ë°˜</p>
                </div>
            </div>

            <div class="race-summary">
                <h3 style="margin-top: 0; font-size:1.2rem; color:var(--main-color);"><i class="fa-solid fa-flag-checkered"></i> ëŒ€íšŒ ìƒì„¸ ì •ë³´</h3>
                <div id="race-desc" style="white-space: pre-wrap; font-size: 1.05rem;"></div>
            </div>

            <div class="rating-card">
                <h3 style="margin-top: 0; color: #1a1a1a; font-size:1.2rem;">ğŸ† ë ˆì´ìŠ¤ëŠ” ì–´ë– ì…¨ë‚˜ìš”?</h3>
                <p style="color: #999; font-size: 0.85rem; margin-bottom: 25px;">ê° í•­ëª©ë³„ë¡œ 10ì  ë§Œì  í‰ì ì„ ë‚¨ê²¨ì£¼ì„¸ìš”.</p>
                
                <div id="vote-form">
                    <div class="rating-item"><span class="rating-label">ğŸƒ ì½”ìŠ¤ (Course)</span> <select class="rating-select" id="v-course"></select></div>
                    <div class="rating-item"><span class="rating-label">ğŸ”§ ìš´ì˜ (Management)</span> <select class="rating-select" id="v-management"></select></div>
                    <div class="rating-item"><span class="rating-label">ğŸ¥› ë³´ê¸‰ (Supplies)</span> <select class="rating-select" id="v-supplies"></select></div>
                    <div class="rating-item"><span class="rating-label">ğŸ ê¸°ë…í’ˆ (Souvenirs)</span> <select class="rating-select" id="v-souvenirs"></select></div>
                    <div class="rating-item"><span class="rating-label">ğŸ’° ê°€ì„±ë¹„ (Cost-Effective)</span> <select class="rating-select" id="v-cost_effective"></select></div>
                    <button onclick="submitVote()" class="submit-btn">í‰ì  ì œì¶œí•˜ê¸°</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const _supabase = supabase.createClient(CONFIG.SUPABASE_URL, CONFIG.SUPABASE_KEY);
        const urlParams = new URLSearchParams(window.location.search);
        const raceId = urlParams.get('id');

        // ë³„ì  ì…€ë ‰íŠ¸ ë°•ìŠ¤ ìƒì„± (10~1ì )
        const indicators = ['v-course', 'v-management', 'v-supplies', 'v-souvenirs', 'v-cost_effective'];
        indicators.forEach(id => {
            const el = document.getElementById(id);
            for(let i=10; i>=1; i--) {
                const opt = document.createElement('option');
                opt.value = i; opt.innerText = i + 'ì ';
                el.appendChild(opt);
            }
        });

        async function initDetail() {
            if (!raceId) { alert("ì˜ëª»ëœ ì ‘ê·¼ì…ë‹ˆë‹¤."); location.href='races.html'; return; }

            try {
                // 1. ëŒ€íšŒ ê¸°ì´ˆ ì •ë³´ (schedules)
                const { data: race, error } = await _supabase.from('schedules').select('*').eq('id', raceId).single();
                if (error) throw error;

                // 2. ì „ë¬¸ê°€ í‰ì  (influencer_reviews)
                const { data: proReviews } = await _supabase.from('influencer_reviews').select('score').eq('race_id', raceId);
                
                // 3. ê¸°ì¡´ reviews DB í‰ì  ë°ì´í„° ì§‘ê³„
                const { data: userReviews } = await _supabase.from('reviews').select('*').eq('race_id', raceId);

                renderPage(race, proReviews || [], userReviews || []);
            } catch (err) {
                console.error(err);
                document.getElementById('loading-view').innerHTML = "ëŒ€íšŒ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";
            }
        }

        function renderPage(race, pros, users) {
            document.getElementById('loading-view').style.display = 'none';
            document.getElementById('main-view').style.display = 'block';

            document.getElementById('race-title').innerText = race.title;
            document.getElementById('race-date').innerText = `ëŒ€íšŒì¼ì : ${race.race_date || 'ë¯¸ì •'}`;
            document.getElementById('race-desc').innerText = race.description || 'ì¤€ë¹„ëœ ëŒ€íšŒ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.';
            
            if (race.video_url) {
                document.getElementById('youtube-player').src = `https://www.youtube.com/embed/${race.video_url}`;
            }

            // ì¸í”Œë£¨ì–¸ì„œ ì ìˆ˜ í‘œì‹œ
            if (pros.length > 0) {
                const proAvg = (pros.reduce((acc, cur) => acc + cur.score, 0) / pros.length).toFixed(1);
                document.getElementById('pro-val').innerText = proAvg;
            }

            // ìœ ì € ì ìˆ˜ ì§‘ê³„ (reviews DBì˜ 5ê°œ ì»¬ëŸ¼ í‰ê· ê°’ ê³„ì‚°)
            if (users.length > 0) {
                const totalPoints = users.reduce((acc, cur) => 
                    acc + (cur.course + cur.management + cur.supplies + cur.souvenirs + cur.cost_effective), 0);
                const avg = (totalPoints / (users.length * 5)).toFixed(1);
                document.getElementById('user-val').innerText = avg;
                document.getElementById('user-count').innerText = `${users.length}ëª…ì˜ ëŸ¬ë„ˆ ì°¸ì—¬`;
            }
        }

        // ğŸ—³ï¸ ê¸°ì¡´ reviews DBë¡œ í‰ì  ë“±ë¡
        async function submitVote() {
            if(!confirm("ì´ ë ˆì´ìŠ¤ì— í‰ì ì„ ë“±ë¡í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

            const payload = {
                race_id: raceId,
                course: parseInt(document.getElementById('v-course').value),
                management: parseInt(document.getElementById('v-management').value),
                supplies: parseInt(document.getElementById('v-supplies').value),
                souvenirs: parseInt(document.getElementById('v-souvenirs').value),
                cost_effective: parseInt(document.getElementById('v-cost_effective').value)
            };

            const { error } = await _supabase.from('reviews').insert([payload]);
            if (error) {
                alert("ë“±ë¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. DB êµ¬ì¡°ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.");
                console.error(error);
            } else {
                alert("ì„±ê³µì ìœ¼ë¡œ í‰ì ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!");
                location.reload();
            }
        }

        window.onload = initDetail;
    </script>
</body>
</html>