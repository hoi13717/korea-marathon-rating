<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>런스탠다드 | 대회 상세 정보</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="config.js"></script>
    <script src="navbar.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css">
    <style>
        :root { 
            --main-color: #e91e63; --pro-color: #66cc33; --bg-color: #f8f9fa;
            --score-red: #ff5252; --score-orange: #ffa726; --score-green: #4caf50; 
        }
        body { font-family: 'Pretendard', sans-serif; background-color: var(--bg-color); margin: 0; padding-bottom: 50px; color: #333; }
        .container { max-width: 800px; margin: 0 auto; padding: 20px 1rem; }

        /* 16. 영상 영역 크기 유지 */
        .video-container { width: 100%; aspect-ratio: 16 / 9; border-radius: 20px; overflow: hidden; background: #000; box-shadow: 0 10px 30px rgba(0,0,0,0.1); margin-bottom: 25px; }

        /* 13. 관리자 개요 영역 */
        .admin-box { background: #fff; padding: 25px; border-radius: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.03); margin-bottom: 25px; border-left: 6px solid var(--main-color); }
        .admin-box h4 { margin: 0 0 10px 0; font-size: 1rem; color: var(--main-color); display: flex; align-items: center; gap: 8px; }

        /* 1, 14. 수직형 스코어 영역 */
        .score-stack { display: flex; flex-direction: column; gap: 15px; margin-bottom: 30px; }
        .score-card { background: white; border-radius: 25px; padding: 25px; box-shadow: 0 4px 15px rgba(0,0,0,0.02); }
        .score-header { display: flex; align-items: center; gap: 15px; }
        .badge-circle { width: 70px; height: 70px; border-radius: 20px; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; font-weight: 900; }
        .num-lg { font-size: 1.8rem; line-height: 1; }
        .label-sm { font-size: 0.6rem; margin-top: 3px; font-weight: 800; }

        /* 2, 15. 유저 평점 영역 내 베스트 댓글 */
        .best-mini-container { margin-top: 15px; border-top: 1px solid #f5f5f5; padding-top: 15px; }
        .best-mini-item { background: #fffdf0; border: 1px solid #fff5cc; padding: 12px; border-radius: 12px; margin-bottom: 8px; font-size: 0.85rem; }
        .best-tag { background: #ffc107; color: #856404; font-size: 0.65rem; padding: 2px 6px; border-radius: 4px; font-weight: 900; margin-right: 6px; }

        /* 9. 점수별 색상 규격 */
        .bg-red { background: var(--score-red); } .bg-orange { background: var(--score-orange); } .bg-green { background: var(--score-green); }

        /* 12. 코멘트 공백 최적화 */
        .review-text { font-size: 0.95rem; line-height: 1.6; color: #444; white-space: pre-wrap; word-break: break-all; }

        /* 11. 연관 대회 */
        .related-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-top: 20px; }
        .rel-card { background: white; border-radius: 15px; overflow: hidden; box-shadow: 0 5px 15px rgba(0,0,0,0.04); cursor: pointer; transition: 0.3s; }
        .rel-title { padding: 12px; font-size: 0.85rem; font-weight: 800; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* 공통 버튼 */
        .interaction-bar { display: flex; gap: 18px; margin-top: 15px; border-top: 1px solid #f8f8f8; padding-top: 12px; }
        .inter-btn { background: none; border: none; font-size: 0.8rem; color: #999; cursor: pointer; font-weight: 700; display: flex; align-items: center; gap: 5px; }
    </style>
</head>
<body>
    <div class="container">
        <div id="status-view" style="text-align:center; padding:100px 0;"><i class="fa-solid fa-spinner fa-spin fa-3x" style="color:#eee;"></i></div>

        <div id="main-view" style="display:none;">
            <h2 id="race-title" style="font-weight: 900; letter-spacing: -1.5px; margin-bottom: 20px; font-size: 1.8rem;"></h2>
            
            <div class="video-container"><iframe id="youtube-player" width="100%" height="100%" frameborder="0" allowfullscreen></iframe></div>

            <div class="admin-box">
                <h4><i class="fa-solid fa-file-invoice"></i> 사이트 관리자 한마디</h4>
                <div id="admin-desc" class="admin-text"></div>
            </div>

            <div class="score-stack">
                <div class="score-card">
                    <div class="score-header">
                        <div class="badge-circle" style="background:var(--pro-color);"><span class="num-lg" id="pro-val">-</span><span class="label-sm">PROS</span></div>
                        <div><h4 style="margin:0; font-size:1.1rem;">전문가 평균 평점</h4><p style="margin:2px 0 0; font-size:0.8rem; color:#999;">러닝 인플루언서 공식 기록</p></div>
                    </div>
                </div>
                
                <div class="score-card">
                    <div class="score-header">
                        <div class="badge-circle" id="user-avg-badge"><span class="num-lg" id="user-val">-</span><span class="label-sm">USERS</span></div>
                        <div><h4 style="margin:0; font-size:1.1rem;">러너 평균 평점</h4><p id="user-count" style="margin:2px 0 0; font-size:0.8rem; color:#999;"></p></div>
                    </div>
                    <div id="best-comments-area" class="best-mini-container"></div>
                </div>
            </div>

            <div id="review-list"></div>
            
            <div id="load-more-container" style="text-align:center; margin:30px 0;">
                <button class="load-more-btn" style="padding:12px 35px; border-radius:50px; border:1px solid #ddd; background:#fff; cursor:pointer; font-weight:800; color:#888;" onclick="loadMore()">리뷰 10개 더보기</button>
            </div>

            <div style="margin-top:50px; border-top:1px solid #eee; padding-top:30px;">
                <h3 style="font-size:1.1rem; font-weight:900;"><i class="fa-solid fa-link"></i> 지금 가장 핫한 레이스</h3>
                <div class="related-grid" id="related-list"></div>
            </div>
        </div>
    </div>

    <script>
        const _supabase = supabase.createClient(CONFIG.SUPABASE_URL, CONFIG.SUPABASE_KEY);
        const urlParams = new URLSearchParams(window.location.search);
        const raceId = urlParams.get('id');

        let offset = 0;
        let bestIds = [];

        // 1, 9. 점수 색상 규격 함수
        function getScoreColorClass(score) {
            if (score <= 3) return 'bg-red';
            if (score <= 6) return 'bg-orange';