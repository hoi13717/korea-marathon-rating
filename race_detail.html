<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ëŸ°ìŠ¤íƒ ë‹¤ë“œ | ëŒ€íšŒ ìƒì„¸ ì •ë³´</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="config.js"></script>
    <script src="navbar.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --main-color: #e91e63; --pro-color: #66cc33; --bg-color: #f0f2f5; --best-gold: #ffc107; --red-score: #ff5252; --orange-score: #ffa726; --green-score: #66cc33; }
        body { font-family: 'Pretendard', sans-serif; background-color: var(--bg-color); margin: 0; padding-bottom: 50px; }
        .container { max-width: 800px; margin: 0 auto; padding: 20px 1rem; }

        /* 14. ìˆ˜ì§ ë°°ì—´ ì ìˆ˜ ì˜ì—­ */
        .score-column { display: flex; flex-direction: column; gap: 15px; margin: 25px 0; }
        .score-item { display: flex; align-items: center; background: white; padding: 15px 20px; border-radius: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.03); }
        .score-box-mini { width: 60px; height: 60px; border-radius: 12px; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; font-weight: 900; margin-right: 15px; }
        .score-box-mini.pro { background: var(--pro-color); }
        .score-box-mini.user { background: var(--main-color); }
        .score-num-mini { font-size: 1.5rem; line-height: 1; }
        .score-label-mini { font-size: 0.6rem; font-weight: 800; }

        .video-container { width: 100%; aspect-ratio: 16 / 9; border-radius: 20px; overflow: hidden; background: #000; box-shadow: 0 10px 30px rgba(0,0,0,0.1); margin-bottom: 20px; }

        /* 13. ê´€ë¦¬ì ê°œìš” ì˜ì—­ */
        .admin-overview { background: #fff; border-left: 5px solid var(--main-color); padding: 20px; border-radius: 15px; margin-bottom: 25px; box-shadow: 0 4px 15px rgba(0,0,0,0.02); }
        .admin-overview h4 { margin: 0 0 10px 0; font-size: 0.9rem; color: var(--main-color); }
        .admin-text { font-size: 0.95rem; line-height: 1.7; color: #444; }

        /* â­ ë² ìŠ¤íŠ¸ ë¦¬ë·° ì˜ì—­ (ìµœì†Œí™”) */
        .best-section { display: flex; flex-direction: column; gap: 10px; margin-bottom: 20px; }
        .best-card { background: #fffdf0; border: 1.5px solid var(--best-gold); padding: 12px 15px; border-radius: 15px; position: relative; }
        
        /* 9. ì ìˆ˜ë³„ ìƒ‰ìƒ í´ë˜ìŠ¤ */
        .avg-badge { padding: 3px 8px; border-radius: 8px; color: white; font-weight: 900; font-size: 0.75rem; }
        .bg-red { background: var(--red-score); }
        .bg-orange { background: var(--orange-score); }
        .bg-green { background: var(--green-score); }

        /* ë¦¬ë·° ë¦¬ìŠ¤íŠ¸ UI */
        .review-item { background: white; border-radius: 20px; padding: 20px; margin-top: 15px; border: 1px solid #f0f0f0; }
        .review-scores { display: flex; gap: 5px; margin: 10px 0; flex-wrap: wrap; }
        .score-tag { font-size: 0.7rem; background: #f8f9fa; padding: 3px 7px; border-radius: 6px; color: #666; border: 1px solid #eee; }
        .review-text { font-size: 0.95rem; line-height: 1.6; color: #333; }
        .interaction-bar { display: flex; gap: 15px; margin-top: 12px; border-top: 1px solid #f8f8f8; padding-top: 10px; }
        .inter-btn { background: none; border: none; font-size: 0.8rem; color: #999; cursor: pointer; font-weight: 700; }

        /* 11. ì—°ê´€ ëŒ€íšŒ */
        .related-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-top: 15px; }
        .related-card { background: white; border-radius: 15px; overflow: hidden; box-shadow: 0 4px 10px rgba(0,0,0,0.05); cursor: pointer; }
        .related-title { padding: 10px; font-size: 0.85rem; font-weight: 800; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    </style>
</head>
<body>
    <div class="container">
        <div id="status-view" style="text-align:center; padding:100px 0;"><i class="fa-solid fa-spinner fa-spin fa-2x" style="color:#ddd;"></i></div>

        <div id="main-view" style="display:none;">
            <h2 id="race-title" style="font-weight: 900; letter-spacing: -1.5px; margin-bottom: 20px;"></h2>
            
            <div class="video-container"><iframe id="youtube-player" width="100%" height="100%" frameborder="0" allowfullscreen></iframe></div>

            <div class="admin-overview">
                <h4><i class="fa-solid fa-bullhorn"></i> ëŒ€íšŒ ê°œìš”</h4>
                <div id="admin-desc" class="admin-text"></div>
            </div>

            <div class="score-column">
                <div class="score-item">
                    <div class="score-box-mini pro"><span class="score-num-mini" id="pro-val">-</span><span class="score-label-mini">PROS</span></div>
                    <div><h4 style="margin:0;">ì „ë¬¸ê°€ í‰ê·  í‰ì </h4><p style="margin:0; font-size:0.75rem; color:#999;">ê³µì‹ ì¸í”Œë£¨ì–¸ì„œ ë¦¬ë·° í•©ì‚°</p></div>
                </div>
                <div class="score-item">
                    <div class="score-box-mini user"><span class="score-num-mini" id="user-val">-</span><span class="score-label-mini">USERS</span></div>
                    <div><h4 style="margin:0;">ëŸ¬ë„ˆ í‰ê·  í‰ì </h4><p id="user-count" style="margin:0; font-size:0.75rem; color:#999;"></p></div>
                </div>
            </div>

            <div id="best-area" class="best-section"></div>

            <div id="review-list"></div>
            
            <div id="load-more-container" style="text-align:center; margin:20px 0;">
                <button class="load-more-btn" style="padding:10px 30px; border-radius:20px; border:1px solid #ddd; background:#fff; cursor:pointer;" onclick="loadMore()">ë¦¬ë·° 10ê°œ ë”ë³´ê¸°</button>
            </div>

            <div style="margin-top:40px;">
                <h3 style="font-size:1.1rem; font-weight:900;"><i class="fa-solid fa-link"></i> ì—°ê´€ëœ ëŒ€íšŒ ì¶”ì²œ</h3>
                <div class="related-grid" id="related-list"></div>
            </div>
        </div>
    </div>

    <script>
        const _supabase = supabase.createClient(CONFIG.SUPABASE_URL, CONFIG.SUPABASE_KEY);
        const urlParams = new URLSearchParams(window.location.search);
        const raceId = urlParams.get('id');

        let offset = 0;
        let bestIds = [];

        async function init() {
            if (!raceId) return;
            try {
                // 11. ì¡°íšŒìˆ˜ ì—…ë°ì´íŠ¸ ë¡œì§ ë³‘í–‰
                await _supabase.rpc('increment_views', { r_id: raceId });

                const { data: race } = await _supabase.from('schedules').select('*').eq('id', raceId).single();
                document.getElementById('race-title').innerText = race.title;
                document.getElementById('admin-desc').innerText = race.description || 'ëŒ€íšŒ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤.';
                if (race.video_url) document.getElementById('youtube-player').src = `https://www.youtube.com/embed/${race.video_url}`;

                // 1. ì „ì²´ í‰ê· ì¹˜ ë° ë² ìŠ¤íŠ¸ ì¶”ì¶œ
                const { data: all } = await _supabase.from('reviews').select('*').eq('race_id', raceId);
                if (all && all.length > 0) {
                    const totalAvg = (all.reduce((s, r) => s + (r.course + r.management + r.supplies + r.souvenirs + r.cost_effective), 0) / (all.length * 5)).toFixed(1);
                    document.getElementById('user-val').innerText = totalAvg;
                    document.getElementById('user-count').innerText = `${all.length}ëª…ì˜ ì‹¤ì œ ëŸ¬ë„ˆê°€ í‰ê°€í•¨`;

                    // 2, 7. ë² ìŠ¤íŠ¸ 3 ì„ ì • (ë¸”ë¼ì¸ë“œ ì œì™¸)
                    const valids = all.filter(r => !(r.reports >= 5 && r.reports > (r.likes || 0)));
                    const sortedBests = valids.sort((a,b) => (b.likes || 0) - (a.likes || 0)).slice(0, 3);
                    bestIds = sortedBests.map(b => b.id);
                    renderBests(sortedBests);
                }

                await loadMore();
                loadRelated();

                document.getElementById('status-view').style.display = 'none';
                document.getElementById('main-view').style.display = 'block';
            } catch (err) { console.error(err); }
        }

        // 9. í‰ì  ìƒ‰ìƒ ê³„ì‚° í•¨ìˆ˜
        function getAvgColor(avg) {
            if (avg <= 3) return 'bg-red';
            if (avg <= 6) return 'bg-orange';
            return 'bg-green';
        }

        function renderBests(data) {
            const area = document.getElementById('best-area');
            area.innerHTML = data.map(r => {
                const avg = ((r.course + r.management + r.supplies + r.souvenirs + r.cost_effective) / 5).toFixed(1);
                return `
                <div class="best-card">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;">
                        <span style="font-size:0.75rem; font-weight:900; color:var(--best-gold);"><i class="fa-solid fa-crown"></i> BEST</span>
                        <span class="avg-badge ${getAvgColor(avg)}">${avg}ì </span>
                    </div>
                    <div class="review-text" style="font-size:0.85rem; color:#555;">${r.comment.length > 50 ? r.comment.substring(0, 50) + '... <span style="color:var(--main-color); cursor:pointer;">ë”ë³´ê¸°</span>' : r.comment}</div>
                </div>`;
            }).join('');
        }

        async function loadMore() {
            const { data } = await _supabase.from('reviews').select('*').eq('race_id', raceId)
                .order('created_at', { ascending: false }).range(offset, offset + 9);
            if (data) {
                const list = document.getElementById('review-list');
                list.insertAdjacentHTML('beforeend', data.filter(r => !bestIds.includes(r.id)).map(r => createItem(r)).join(''));
                offset += 10;
            }
        }

        // 8, 9, 12. ê°œë³„ ë¦¬ë·° ì•„ì´í…œ ìƒì„±
        function createItem(r) {
            const avg = ((r.course + r.management + r.supplies + r.souvenirs + r.cost_effective) / 5).toFixed(1);
            const isBlinded = (r.reports >= 5 && r.reports > (r.likes || 0)); // 4. ë¸”ë¼ì¸ë“œ ë¡œì§
            
            // 12. ê³µë°± ì œê±° ì²˜ë¦¬
            const cleanComment = r.comment ? r.comment.trim().replace(/\n{3,}/g, '\n\n') : 'ì½”ë©˜íŠ¸ ì—†ìŒ';

            return `
            <div class="review-item" id="rev-${r.id}">
                <div class="review-meta">
                    <span>ğŸ‘¤ ${r.author_name} <span class="avg-badge ${getAvgColor(avg)}">${avg}ì </span></span>
                    <span>${new Date(r.created_at).toLocaleDateString()}</span>
                </div>
                ${!isBlinded ? `
                    <div class="review-scores">
                        <span class="score-tag">ğŸ—ºï¸ ì½”ìŠ¤ ${r.course}</span><span class="score-tag">ğŸ¢ ìš´ì˜ ${r.management}</span>
                        <span class="score-tag">ğŸ¥› ë³´ê¸‰ ${r.supplies}</span><span class="score-tag">ğŸ‘• ê¸°ë…í’ˆ ${r.souvenirs}</span>
                        <span class="score-tag">ğŸ’° ê°€ì„±ë¹„ ${r.cost_effective}</span>
                    </div>
                    <div class="review-text">${cleanComment}</div>
                ` : '<p style="color:#ccc; font-style:italic; font-size:0.8rem;">ì‹ ê³  ëˆ„ì ìœ¼ë¡œ ë¸”ë¼ì¸ë“œ ì²˜ë¦¬ëœ ë¦¬ë·°ì…ë‹ˆë‹¤.</p>'}
                <div class="interaction-bar">
                    <button class="inter-btn" onclick="handleLike('${r.id}', ${r.likes || 0})"><i class="fa-regular fa-thumbs-up"></i> ${r.likes || 0}</button>
                    <button class="inter-btn" onclick="handleReport('${r.id}', ${r.reports || 0})"><i class="fa-solid fa-ban"></i> ì‹ ê³ </button>
                    <div class="review-actions"><span onclick="handleDelete('${r.id}')">ì‚­ì œ</span></div>
                </div>
            </div>`;
        }

        // 11. ì—°ê´€ ëŒ€íšŒ (ë¯¸ê°œìµœ ì¤‘ ì¡°íšŒìˆ˜ ìˆœ)
        async function loadRelated() {
            const now = new Date().toISOString().split('T')[0];
            const { data } = await _supabase.from('schedules').select('*').neq('id', raceId)
                .gte('race_date', now).order('views', { ascending: false }).limit(4);
            if (data) {
                document.getElementById('related-list').innerHTML = data.map(r => `
                    <div class="related-card" onclick="location.href='race_detail.html?id=${r.id}'">
                        <img src="${r.poster_url}" style="width:100%; height:120px; object-fit:cover;">
                        <div class="related-title">${r.title}</div>
                    </div>`).join('');
            }
        }

        // 5, 6, 10. ê¸°ëŠ¥ í•¨ìˆ˜ (ìƒëµ ì—†ì´ ë¡œì§ ë³´ì™„)
        async function handleLike(id, cur) { await _supabase.from('reviews').update({ likes: cur + 1 }).eq('id', id); location.reload(); }
        async function handleReport(id, cur) { 
            if(!confirm("ì‹ ê³ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
            await _supabase.from('reviews').update({ reports: cur + 1 }).eq('id', id); 
            alert("ì‹ ê³  ì ‘ìˆ˜ ì™„ë£Œ"); location.reload(); 
        }
        async function handleDelete(id) { 
            const pw = prompt("ì•”í˜¸ 6ìë¦¬"); 
            const { data } = await _supabase.from('reviews').delete().eq('id', id).eq('password', pw).select();
            if(data && data.length > 0) location.reload(); else alert("ì•”í˜¸ ë¶ˆì¼ì¹˜");
        }

        window.onload = init;
    </script>
</body>
</html>