<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ëŸ°ìŠ¤íƒ ë‹¤ë“œ | ìƒì„¸ ë¦¬í¬íŠ¸</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="config.js"></script>
    <script src="navbar.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css">
    <style>
        :root { 
            --main-color: #e91e63; --pro-color: #66cc33; --bg-color: #f8f9fa;
            --score-red: #ff5252; --score-orange: #ffa726; --score-green: #4caf50; --best-gold: #ffc107;
        }
        body { font-family: 'Pretendard', sans-serif; background-color: var(--bg-color); margin: 0; padding-bottom: 50px; color: #333; }
        .container { max-width: 800px; margin: 0 auto; padding: 20px 1rem; }

        /* A, E. ë””ìì¸ ë ˆì´ì•„ì›ƒ ë° í†¤ì•¤ë§¤ë„ˆ */
        .card-ui { background: white; border-radius: 25px; box-shadow: 0 4px 15px rgba(0,0,0,0.03); border: 1px solid #f0f0f0; margin-bottom: 25px; overflow: hidden; }
        .video-container { width: 100%; aspect-ratio: 16 / 9; background: #000; box-shadow: 0 10px 30px rgba(0,0,0,0.1); border-radius: 25px; overflow: hidden; margin-bottom: 25px; }
        .admin-report { padding: 25px; border-left: 8px solid var(--main-color); background: #fff; border-radius: 25px; margin-bottom: 25px; box-shadow: 0 4px 15px rgba(0,0,0,0.03); }

        /* B. ìˆ˜ì§í˜• ìŠ¤ì½”ì–´ë³´ë“œ */
        .score-stack { display: flex; flex-direction: column; gap: 15px; margin-bottom: 25px; }
        .badge-circle { width: 75px; height: 75px; border-radius: 22px; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; font-weight: 900; }
        
        /* 9, 11. ë² ìŠ¤íŠ¸ ëŒ“ê¸€ ì˜ì—­ (ìˆ˜í‰ ë²„íŠ¼ ë‚˜ì—´) */
        .best-mini-wrap { background: #fffdf0; border: 1.5px solid var(--best-gold); margin-top: 15px; padding: 20px; border-radius: 20px; }
        .best-item { border-bottom: 1.5px solid #eee; padding-bottom: 15px; margin-bottom: 15px; }
        .best-item:last-child { border-bottom: none; }

        /* C, 12~19. ë¦¬ë·° ì…ë ¥ì°½ ë° í”„ë¡œê·¸ë ˆìŠ¤ë°” */
        .rating-card { padding: 30px; }
        .input-row { display: flex; gap: 12px; margin-bottom: 15px; flex-wrap: wrap; }
        .form-input { flex: 1; min-width: 150px; padding: 14px 18px; border-radius: 14px; border: 1.5px solid #eee; outline: none; transition: 0.3s; font-family: inherit; }
        .form-input:focus { border-color: var(--main-color); background: #fffafc; }
        .comment-area { width: 100%; height: 160px; padding: 18px; border-radius: 18px; border: 1.5px solid #eee; resize: none; box-sizing: border-box; outline: none; line-height: 1.7; font-family: inherit; }
        .progress-bg { width: 100%; height: 8px; background: #f0f0f0; border-radius: 10px; margin: 10px 0; overflow: hidden; }
        .progress-fill { width: 0%; height: 100%; background: var(--main-color); transition: 0.3s; }
        
        /* 8. 4ëŒ€ ì§€í‘œ í‰ì  ì…ë ¥ ì˜ì—­ */
        .metric-input-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 15px; }
        .metric-field { background: #f8f9fa; padding: 10px; border-radius: 12px; display: flex; align-items: center; justify-content: space-between; font-size: 0.85rem; font-weight: 700; }
        .metric-field input { width: 50px; border: 1.5px solid #eee; border-radius: 8px; padding: 4px; text-align: center; }

        /* D, 4, 16, 21. ë¦¬ë·° ë¦¬ìŠ¤íŠ¸ & ìµœì´ˆ í•œ ì¤„ ë…¸ì¶œ */
        .review-item { padding: 25px; margin-top: 15px; background: white; border-radius: 25px; border: 1px solid #f0f0f0; }
        .review-text { 
            font-size: 1rem; line-height: 1.7; color: #444; 
            white-space: pre-line; word-break: break-all; 
            overflow: hidden; text-overflow: ellipsis;
            display: -webkit-box; -webkit-line-clamp: 1; -webkit-box-orient: vertical;
        }
        .review-text.expanded { -webkit-line-clamp: unset; display: block; }
        .more-trigger { color: var(--main-color); font-weight: 800; cursor: pointer; font-size: 0.85rem; margin-top: 8px; display: inline-block; text-decoration: underline; }

        /* 3, 6, 11. No-Reload ìƒí˜¸ì‘ìš© ë° ìˆ˜í‰ ë²„íŠ¼ */
        .interaction-bar { display: flex; gap: 10px; margin-top: 15px; border-top: 1px solid #f8f8f8; padding-top: 15px; align-items: center; flex-wrap: wrap; }
        .inter-btn { background: #fff; border: 1.5px solid #eee; padding: 6px 14px; border-radius: 50px; font-size: 0.8rem; color: #777; cursor: pointer; font-weight: 700; transition: 0.2s; display: flex; align-items: center; gap: 6px; font-family: inherit; }
        .inter-btn:hover { border-color: var(--main-color); color: var(--main-color); background: #fffafc; }
        .active-like { color: var(--main-color); border-color: var(--main-color); background: #fffafc; }

        /* 2, 7, 21. ìƒ‰ìƒ ë° 4ëŒ€ ì§€í‘œ í…ìŠ¤íŠ¸ í‘œì‹œ */
        .badge-val { padding: 3px 10px; border-radius: 10px; color: #fff; font-weight: 900; font-size: 0.75rem; margin-left: 5px; }
        .bg-red { background: var(--score-red); } .bg-orange { background: var(--score-orange); } .bg-green { background: var(--score-green); }
        .score-tag { font-size: 0.7rem; background: #f8f9fa; padding: 3px 8px; border-radius: 8px; color: #666; font-weight: 700; margin-right: 5px; border: 1px solid #eee; }

        /* 24, 25. ì—°ê´€ ëŒ€íšŒ ë¦¬ìŠ¤íŠ¸ */
        .related-section { margin-top: 60px; border-top: 1.5px solid #eee; padding-top: 40px; }
        .related-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; }
        .rel-card { background: white; border-radius: 15px; overflow: hidden; box-shadow: 0 4px 10px rgba(0,0,0,0.05); cursor: pointer; text-align: center; font-size: 0.75rem; padding-bottom: 10px; border: 1px solid #f0f0f0; }
        .rel-img { width: 100%; height: 75px; object-fit: cover; background: #eee; margin-bottom: 8px; }

        .submit-btn { width: 100%; padding: 18px; background: var(--main-color); color: white; border: none; border-radius: 15px; font-weight: 900; font-size: 1.1rem; cursor: pointer; transition: 0.3s; font-family: inherit; }
        
        /* 6. í˜ì´ì§€ ë‚´ ìˆ˜ì • ì—ë””í„° */
        .edit-box { display: none; margin-top: 10px; width: 100%; }
        .edit-area { width: 100%; height: 100px; padding: 12px; border-radius: 12px; border: 1.5px solid var(--main-color); font-family: inherit; font-size: 0.95rem; resize: none; margin-bottom: 8px; }
    </style>
</head>
<body>
    <div class="container">
        <div id="status-view" style="text-align:center; padding:120px 0;"><i class="fa-solid fa-circle-notch fa-spin fa-3x" style="color:#eee;"></i></div>

        <div id="main-view" style="display:none;">
            <h2 id="race-title" style="font-weight:900; font-size:2.2rem; margin-bottom:25px; letter-spacing:-1.8px;"></h2>
            <div class="video-container"><iframe id="youtube-player" width="100%" height="100%" frameborder="0" allowfullscreen></iframe></div>

            <div class="admin-report">
                <h4 style="margin:0 0 10px; color:var(--main-color);"><i class="fa-solid fa-bullhorn"></i> ëŸ°ìŠ¤íƒ ë‹¤ë“œ ê³µì‹ ë¦¬í¬íŠ¸</h4>
                <div id="admin-desc" style="font-size:0.95rem; line-height:1.7; color:#555;"></div>
            </div>

            <div class="score-stack">
                <div class="card-ui" style="padding:25px; margin-bottom:0;"><div style="display:flex; align-items:center; gap:15px;"><div class="badge-circle" style="background:var(--pro-color);"><span id="pro-val" style="font-size:2rem;">-</span><span style="font-size:0.6rem; font-weight:800;">PROS</span></div><h4 style="margin:0;">ì „ë¬¸ê°€ í‰ê·  í‰ì </h4></div></div>
                <div class="card-ui" style="padding:25px; margin-bottom:0;">
                    <div style="display:flex; align-items:center; gap:15px;">
                        <div class="badge-circle" id="user-avg-badge"><span id="user-val" style="font-size:2rem;">-</span><span style="font-size:0.6rem; font-weight:800;">USERS</span></div>
                        <div><h4 style="margin:0;">ëŸ¬ë„ˆ í‰ê·  í‰ì </h4><p id="user-count" style="margin:0; font-size:0.8rem; color:#999;"></p></div>
                    </div>
                    <div id="best-area" class="best-mini-wrap" style="display:none;"><div style="font-size:0.85rem; font-weight:900; color:var(--best-gold); margin-bottom:15px;"><i class="fa-solid fa-crown"></i> ëŸ°ìŠ¤íƒ ë‹¤ë“œ ë² ìŠ¤íŠ¸</div><div id="best-list"></div></div>
                </div>
            </div>

            <div class="card-ui rating-card">
                <h3 style="margin:0 0 20px 0; font-size:1.2rem; font-weight:900;">ğŸ… ì˜¬ë°”ë¥¸ ëŒ€íšŒë¬¸í™” ë§Œë“¤ê¸°</h3>
                <div class="input-row">
                    <input type="text" id="v-author" class="form-input">
                    <input type="password" id="v-pw" class="form-input" maxlength="6" placeholder="ì•”í˜¸ 6ìë¦¬" inputmode="numeric">
                </div>
                <div class="metric-input-grid">
                    <div class="metric-field">ğŸ—ºï¸ ì½”ìŠ¤ <input type="number" id="sc-course" min="1" max="10" value="10"></div>
                    <div class="metric-field">ğŸ”§ ìš´ì˜ <input type="number" id="sc-manage" min="1" max="10" value="10"></div>
                    <div class="metric-field">ğŸ‘• ê¸°ë…í’ˆ <input type="number" id="sc-souv" min="1" max="10" value="10"></div>
                    <div class="metric-field">ğŸ’° ê°€ì„±ë¹„ <input type="number" id="sc-cost" min="1" max="10" value="10"></div>
                </div>
                <textarea id="v-comment" class="comment-area" maxlength="300" placeholder="ì˜¬ë°”ë¥¸ ëŒ€íšŒë¬¸í™” ë§Œë“¤ê¸°ì— ë™ì°¸í•´ì£¼ì„¸ìš”!"></textarea>
                <div class="progress-bg"><div id="v-progress" class="progress-fill"></div></div>
                <div style="text-align:right; font-size:0.8rem; color:#999; margin-bottom:20px;"><span id="v-count">0</span> / 300</div>
                <button onclick="submitVote()" class="submit-btn">[ì½”ë©˜íŠ¸ ì‘ì„±]</button>
            </div>

            <div id="review-list"></div>
            
            <div id="load-more-container" style="text-align:center; margin:35px 0; display:none;">
                <button class="inter-btn" style="padding:14px 45px; border-radius:50px; font-size:1rem; margin:0 auto;" onclick="loadMore()">[ëŒ€íšŒí›„ê¸° ë”ë³´ê¸°]</button>
            </div>

            <div class="related-section">
                <h3 style="font-size:1.1rem; font-weight:900; margin-bottom:20px;">ğŸƒ ì§€ê¸ˆ ì£¼ëª©ë°›ëŠ” ë‹¤ë¥¸ ë ˆì´ìŠ¤</h3>
                <div class="related-grid" id="related-list"></div>
            </div>
        </div>
    </div>

    <script>
        const _supabase = supabase.createClient(CONFIG.SUPABASE_URL, CONFIG.SUPABASE_KEY);
        const urlParams = new URLSearchParams(window.location.search);
        const raceId = urlParams.get('id');
        let offset = 0; let bestIds = [];

        function getScoreColor(score) {
            if (score <= 3) return 'bg-red';
            if (score <= 6) return 'bg-orange';
            return 'bg-green';
        }

        function sanitizeText(text) { return text.trim().replace(/\n{3,}/g, '\n\n'); }

        async function init() {
            if (!raceId) return;
            setNickname();
            try {
                await _supabase.rpc('increment_views', { r_id: raceId });
                const { data: race } = await _supabase.from('schedules').select('*').eq('id', raceId).single();
                document.getElementById('race-title').innerText = race.title;
                document.getElementById('admin-desc').innerText = race.description || 'ìš´ì˜ì§„ ë¦¬í¬íŠ¸ ì¤€ë¹„ ì¤‘';
                if (race.video_url) document.getElementById('youtube-player').src = `https://www.youtube.com/embed/${race.video_url}`;

                const { data: all } = await _supabase.from('reviews').select('*').eq('race_id', raceId);
                if (all && all.length > 0) {
                    const avg = (all.reduce((s, r) => s + (r.course+r.management+r.souvenirs+r.cost_effective), 0) / (all.length * 4)).toFixed(1);
                    document.getElementById('user-val').innerText = avg;
                    document.getElementById('user-avg-badge').className = `badge-circle ${getScoreColor(avg)}`;
                    document.getElementById('user-count').innerText = `${all.length}ëª…ì˜ ë°ì´í„° ì§‘ê³„`;

                    // 10. ë² ìŠ¤íŠ¸ ì„ ì • (ë¸”ë¼ì¸ë“œ ì œì™¸)
                    const valids = all.filter(r => !(r.reports >= 5 && r.reports > (r.likes || 0)));
                    const sortedBests = valids.sort((a,b) => (b.likes || 0) - (a.likes || 0)).slice(0, 3);
                    bestIds = sortedBests.map(b => b.id);
                    
                    if (sortedBests.length > 0) {
                        document.getElementById('best-area').style.display = 'block';
                        document.getElementById('best-list').innerHTML = sortedBests.map(r => createItemHTML(r, true)).join('');
                    }
                }

                await loadMore();
                loadRelated();
                document.getElementById('status-view').style.display = 'none';
                document.getElementById('main-view').style.display = 'block';
            } catch (err) { console.error(err); }
        }

        async function loadMore() {
            const { data } = await _supabase.from('reviews').select('*').eq('race_id', raceId).order('created_at', { ascending: false }).range(offset, offset + 9);
            if (data && data.length > 0) {
                const html = data.filter(r => !bestIds.includes(r.id)).map(r => createItemHTML(r, false)).join('');
                document.getElementById('review-list').insertAdjacentHTML('beforeend', html);
                offset += 10;
                document.getElementById('load-more-container').style.display = (data.length === 10) ? 'block' : 'none';
            }
        }

        // 6, 7, 8, 11, 16, 21. ë¦¬ë·° ìƒì„± ë° ì¸í”Œë ˆì´ìŠ¤ ìˆ˜ì • ëª¨ë“ˆ
        function createItemHTML(r, isBest) {
            const avg = ((r.course+r.management+r.souvenirs+r.cost_effective)/4).toFixed(1);
            const isBlinded = (r.reports >= 5 && r.reports > (r.likes || 0));
            const sfx = isBest ? '-b' : '-n';
            const cleanText = sanitizeText(r.comment || '');

            return `
            <div class="review-item" id="rev-${r.id}${sfx}" style="${isBest ? 'border:1.5px solid var(--best-gold); background:#fffdfa;' : ''}">
                <div style="display:flex; justify-content:space-between; margin-bottom:12px;">
                    <span style="font-weight:900;">ğŸ‘¤ ${r.author_name} ${isBest?'<span class="best-tag-label">BEST</span>':''} <span class="badge-val ${getScoreColor(avg)}">${avg}ì </span></span>
                    <span style="color:#bbb; font-size:0.8rem;">${new Date(r.created_at).toLocaleDateString()}</span>
                </div>
                ${!isBlinded ? `
                    <div style="display:flex; gap:5px; margin-bottom:12px; flex-wrap:wrap;">
                        <span class="score-tag">ğŸ—ºï¸ ì½”ìŠ¤: ${r.course}</span><span class="score-tag">ğŸ”§ ìš´ì˜: ${r.management}</span>
                        <span class="score-tag">ğŸ‘• ê¸°ë…í’ˆ: ${r.souvenirs}</span><span class="score-tag">ğŸ’° ê°€ì„±ë¹„: ${r.cost_effective}</span>
                    </div>
                    <div class="review-text" id="txt-${r.id}${sfx}">${cleanText}</div>
                    <span class="more-trigger" id="more-${r.id}${sfx}" onclick="toggleExpand('${r.id}${sfx}')">ë”ë³´ê¸°</span>
                    
                    <div id="eb-${r.id}${sfx}" class="edit-box">
                        <textarea id="ta-${r.id}${sfx}" class="edit-area">${cleanText}</textarea>
                        <div style="display:flex; gap:8px;">
                            <button class="inter-btn active-like" onclick="saveEdit('${r.id}', '${sfx}')">ì €ì¥</button>
                            <button class="inter-btn" onclick="toggleEditBox('${r.id}', '${sfx}')">ì·¨ì†Œ</button>
                        </div>
                    </div>
                ` : '<p style="color:#ccc; font-style:italic; font-size:0.85rem;">í’ˆì§ˆ ë¯¸ë‹¬ ë¸”ë¼ì¸ë“œ ë¦¬ë·°</p>'}
                <div class="interaction-bar">
                    <button class="inter-btn" id="l-btn-${r.id}${sfx}" onclick="handleLike('${r.id}', ${r.likes || 0})"><i class="fa-regular fa-thumbs-up"></i> <span id="l-cnt-${r.id}${sfx}">${r.likes || 0}</span></button>
                    <button class="inter-btn" onclick="handleEditTrigger('${r.id}', '${sfx}')"><i class="fa-regular fa-pen-to-square"></i> ìˆ˜ì •</button>
                    <button class="inter-btn" onclick="handleDelete('${r.id}')"><i class="fa-regular fa-trash-can"></i> ì‚­ì œ</button>
                    <button class="inter-btn" onclick="handleReport('${r.id}', ${r.likes || 0})"><i class="fa-solid fa-flag"></i> ì‹ ê³ </button>
                </div>
            </div>`;
        }

        function toggleExpand(fullId) {
            const el = document.getElementById(`txt-${fullId}`);
            const btn = document.getElementById(`more-${fullId}`);
            el.classList.toggle('expanded');
            btn.innerText = el.classList.contains('expanded') ? 'ì¤„ì´ê¸°' : 'ë”ë³´ê¸°';
        }

        function toggleEditBox(id, sfx) {
            const box = document.getElementById(`eb-${id}${sfx}`);
            box.style.display = box.style.display === 'block' ? 'none' : 'block';
        }

        async function handleEditTrigger(id, sfx) {
            const pw = prompt("ì•”í˜¸ 6ìë¦¬");
            const { data } = await _supabase.from('reviews').select('id').eq('id', id).eq('password', pw).single();
            if(data) toggleEditBox(id, sfx); else alert("ì•”í˜¸ ë¶ˆì¼ì¹˜");
        }

        async function saveEdit(id, sfx) {
            const newText = document.getElementById(`ta-${id}${sfx}`).value.trim();
            const { error } = await _supabase.from('reviews').update({ comment: newText }).eq('id', id);
            if(!error) { document.querySelectorAll(`[id^="txt-${id}"]`).forEach(el => el.innerText = newText); toggleEditBox(id, sfx); }
        }

        async function handleLike(id, cur) {
            const { error } = await _supabase.from('reviews').update({ likes: cur + 1 }).eq('id', id).select();
            if (!error) {
                document.querySelectorAll(`[id^="l-cnt-${id}"]`).forEach(el => el.innerText = parseInt(el.innerText) + 1);
                document.querySelectorAll(`[id^="l-btn-${id}"]`).forEach(btn => btn.classList.add('active-like'));
            }
        }

        async function handleReport(id, likes) {
            if(!confirm("ì´ í›„ê¸°ë¥¼ ì‹ ê³ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
            const { data } = await _supabase.from('reviews').select('reports').eq('id', id).single();
            const newReports = (data.reports || 0) + 1;
            const { error } = await _supabase.from('reviews').update({ reports: newReports }).eq('id', id).select();
            if (!error) { alert("ì‹ ê³ ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤"); if (newReports >= 5 && newReports > likes) location.reload(); }
        }

        async function handleDelete(id) { 
            const pw = prompt("ì•”í˜¸ 6ìë¦¬"); 
            const { data } = await _supabase.from('reviews').delete().eq('id', id).eq('password', pw).select();
            if(data && data.length > 0) location.reload(); else alert("ì•”í˜¸ ë¶ˆì¼ì¹˜");
        }

        async function loadRelated() {
            const { data } = await _supabase.from('schedules').select('*').neq('id', raceId).gte('race_date', new Date().toISOString().split('T')[0]).order('views', { ascending: false }).limit(4);
            if (data) document.getElementById('related-list').innerHTML = data.map(r => `<div class="rel-card" onclick="location.href='race_detail.html?id=${r.id}'"><img src="${r.poster_url || 'https://via.placeholder.com/300x150'}" class="rel-img"><div style="padding:10px 5px; font-weight:900; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${r.title}</div></div>`).join('');
        }

        document.getElementById('v-comment').addEventListener('input', function() {
            const len = this.value.length;
            document.getElementById('v-count').innerText = len;
            document.getElementById('v-progress').style.width = (len / 300 * 100) + '%';
        });

        function setNickname() {
            const nicks = ["ë‚ ìœ¼ëŠ”ì†Œë‹‰", "ë²ˆê°œì¹˜íƒ€", "ì™„ì£¼ìš”ì •", "ë‚­ë§ŒëŸ¬ë„ˆ", "ì„œë¸Œì“°ë¦¬ì—”ì§„"];
            document.getElementById('v-author').value = nicks[Math.floor(Math.random()*nicks.length)] + Math.floor(1000 + Math.random() * 9000);
        }

        async function submitVote() {
            const pw = document.getElementById('v-pw').value;
            const comment = sanitizeText(document.getElementById('v-comment').value);
            if (pw.length !== 6) return alert("ì•”í˜¸ 6ìë¦¬ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            if (!comment) return alert("ì½”ë©˜íŠ¸ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            const payload = { 
                race_id: raceId, 
                course: parseInt(document.getElementById('sc-course').value),
                management: parseInt(document.getElementById('sc-manage').value),
                souvenirs: parseInt(document.getElementById('sc-souv').value),
                cost_effective: parseInt(document.getElementById('sc-cost').value),
                author_name: document.getElementById('v-author').value, password: pw, comment: comment 
            };
            await _supabase.from('reviews').insert([payload]);
            location.reload();
        }

        window.onload = init;
    </script>
</body>
</html>