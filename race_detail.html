<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ëŸ°ìŠ¤íƒ ë‹¤ë“œ | ëŒ€íšŒ ìƒì„¸ ì •ë³´</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="config.js"></script>
    <script src="navbar.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css">
    <style>
        :root { 
            --main-color: #e91e63; --pro-color: #66cc33; --bg-color: #f8f9fa;
            --score-red: #ff5252; --score-orange: #ffa726; --score-green: #4caf50; 
        }
        body { font-family: 'Pretendard', sans-serif; background-color: var(--bg-color); margin: 0; padding-bottom: 50px; color: #333; }
        .container { max-width: 800px; margin: 0 auto; padding: 20px 1rem; }

        /* 16. ì˜ìƒ ì˜ì—­ */
        .video-container { width: 100%; aspect-ratio: 16 / 9; border-radius: 20px; overflow: hidden; background: #000; box-shadow: 0 10px 30px rgba(0,0,0,0.1); margin-bottom: 25px; }

        /* 13. ê´€ë¦¬ì ê°œìš” */
        .admin-box { background: #fff; padding: 25px; border-radius: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.03); margin-bottom: 25px; border-left: 6px solid var(--main-color); }

        /* 1, 14. ìˆ˜ì§í˜• ìŠ¤ì½”ì–´ ì˜ì—­ */
        .score-stack { display: flex; flex-direction: column; gap: 15px; margin-bottom: 25px; }
        .score-card { background: white; border-radius: 25px; padding: 25px; box-shadow: 0 4px 15px rgba(0,0,0,0.02); }
        .score-header { display: flex; align-items: center; gap: 15px; }
        .badge-circle { width: 75px; height: 75px; border-radius: 22px; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; font-weight: 900; }
        .num-lg { font-size: 2rem; line-height: 1; }
        .label-sm { font-size: 0.65rem; margin-top: 4px; font-weight: 800; }

        /* 2, 15. ìœ ì € í‰ì  ì˜ì—­ ë‚´ ë² ìŠ¤íŠ¸ ëŒ“ê¸€ */
        .best-mini-container { margin-top: 15px; border-top: 1px solid #f5f5f5; padding-top: 15px; }
        .best-mini-item { background: #fffdf0; border: 1px solid #fff5cc; padding: 12px; border-radius: 12px; margin-bottom: 8px; font-size: 0.88rem; }
        .best-tag { background: #ffc107; color: #856404; font-size: 0.68rem; padding: 2px 6px; border-radius: 5px; font-weight: 900; margin-right: 6px; }

        /* â­ 1. í‰ì  ë° ì½”ë©˜íŠ¸ ì…ë ¥ì°½ (í‰ê· í‰ì  ì•„ë˜ ìœ„ì¹˜) */
        .rating-card { background: white; border-radius: 25px; padding: 25px; margin-bottom: 30px; box-shadow: 0 8px 20px rgba(0,0,0,0.05); border: 1.5px solid #eee; }
        .rating-row-container { display: flex; justify-content: space-between; gap: 5px; margin-bottom: 20px; }
        .rating-unit { flex: 1; display: flex; flex-direction: column; align-items: center; text-align: center; }
        .rating-icon { font-size: 1.2rem; margin-bottom: 5px; }
        .rating-unit-label { font-size: 0.7rem; font-weight: 800; color: #777; margin-bottom: 5px; }
        .rating-select-compact { width: 90%; padding: 6px 2px; border: 1.5px solid #eee; border-radius: 10px; font-weight: 900; color: var(--main-color); background: white; outline: none; font-size: 0.8rem; text-align: center; cursor: pointer; }

        /* 2, 3. ì‘ì„±ì ë° ì•”í˜¸ ì…ë ¥ ì˜ì—­ */
        .input-row { display: flex; gap: 10px; margin-bottom: 12px; }
        .form-input { flex: 1; padding: 12px 15px; border-radius: 12px; border: 1.5px solid #eee; font-size: 0.9rem; outline: none; font-weight: 600; }
        .comment-area { width: 100%; height: 90px; padding: 15px; border-radius: 15px; border: 1.5px solid #eee; font-size: 0.95rem; resize: none; box-sizing: border-box; outline: none; margin-bottom: 12px; line-height: 1.6; }
        .submit-btn { width: 100%; padding: 18px; background: var(--main-color); color: white; border: none; border-radius: 15px; font-weight: 900; font-size: 1.1rem; cursor: pointer; transition: 0.3s; }

        /* ë¦¬ë·° ë¦¬ìŠ¤íŠ¸ */
        .review-item { background: white; border-radius: 22px; padding: 22px; margin-top: 15px; border: 1px solid #f0f0f0; }
        .score-tag { font-size: 0.75rem; background: #f8f9fa; padding: 4px 10px; border-radius: 10px; color: #666; font-weight: 700; margin-right: 5px; }
        .bg-red { background: var(--score-red); } .bg-orange { background: var(--score-orange); } .bg-green { background: var(--score-green); }

        .rel-card { background: white; border-radius: 15px; overflow: hidden; box-shadow: 0 5px 15px rgba(0,0,0,0.04); cursor: pointer; }
    </style>
</head>
<body>
    <div class="container">
        <div id="status-view" style="text-align:center; padding:100px 0;"><i class="fa-solid fa-spinner fa-spin fa-3x" style="color:#eee;"></i></div>

        <div id="main-view" style="display:none;">
            <h2 id="race-title" style="font-weight: 900; letter-spacing: -1.8px; margin-bottom: 25px; font-size: 2rem;"></h2>
            
            <div class="video-container"><iframe id="youtube-player" width="100%" height="100%" frameborder="0" allowfullscreen></iframe></div>

            <div class="admin-box">
                <h4><i class="fa-solid fa-feather-pointed"></i> ëŒ€íšŒ ê´€ë¦¬ì ì¸ì‚¬ì´íŠ¸</h4>
                <div id="admin-desc" class="admin-text" style="font-size:0.95rem; line-height:1.7;"></div>
            </div>

            <div class="score-stack">
                <div class="score-card">
                    <div class="score-header">
                        <div class="badge-circle" style="background:var(--pro-color);"><span class="num-lg" id="pro-val">-</span><span class="label-sm">PROS</span></div>
                        <div><h4 style="margin:0; font-size:1.1rem;">ì „ë¬¸ê°€ í‰ì </h4><p style="margin:2px 0 0; font-size:0.8rem; color:#999;">ì¸í”Œë£¨ì–¸ì„œ ê³µì‹ ë¦¬ë·°</p></div>
                    </div>
                </div>
                <div class="score-card">
                    <div class="score-header">
                        <div class="badge-circle" id="user-avg-badge"><span class="num-lg" id="user-val">-</span><span class="label-sm">USERS</span></div>
                        <div><h4 style="margin:0; font-size:1.1rem;">ëŸ¬ë„ˆ í‰ê·  í‰ì </h4><p id="user-count" style="margin:2px 0 0; font-size:0.8rem; color:#999;"></p></div>
                    </div>
                    <div id="best-comments-area" class="best-mini-container"></div>
                </div>
            </div>

            <div class="rating-card">
                <h3 style="margin-top: 0; font-size:1.1rem; margin-bottom:20px;">ğŸƒ ì´ë²ˆ ëŒ€íšŒëŠ” ì–´ë• ë‚˜ìš”?</h3>
                <div class="rating-row-container">
                    <div class="rating-unit"><div class="rating-icon">ğŸ—ºï¸</div><div class="rating-unit-label">ì½”ìŠ¤</div><select class="rating-select-compact" id="v-course"></select></div>
                    <div class="rating-unit"><div class="rating-icon">ğŸ”§</div><div class="rating-unit-label">ìš´ì˜</div><select class="rating-select-compact" id="v-management"></select></div>
                    <div class="rating-unit"><div class="rating-icon">ğŸ¥›</div><div class="rating-unit-label">ë³´ê¸‰</div><select class="rating-select-compact" id="v-supplies"></select></div>
                    <div class="rating-unit"><div class="rating-icon">ğŸ‘•</div><div class="rating-unit-label">ê¸°ë…í’ˆ</div><select class="rating-select-compact" id="v-souvenirs"></select></div>
                    <div class="rating-unit"><div class="rating-icon">ğŸ’°</div><div class="rating-unit-label">ê°€ì„±ë¹„</div><select class="rating-select-compact" id="v-cost_effective"></select></div>
                </div>
                <div class="input-row">
                    <input type="text" id="v-author" class="form-input" placeholder="ì‘ì„±ìëª…">
                    <input type="password" id="v-pw" class="form-input" maxlength="6" placeholder="ì•”í˜¸ ìˆ«ì 6ìë¦¬" inputmode="numeric">
                </div>
                <textarea id="v-comment" class="comment-area" maxlength="1000" placeholder="ì˜ë¯¸ ì—†ëŠ” ê³µë°± ì—†ì´, ìƒìƒí•œ í›„ê¸°ë¥¼ ë“¤ë ¤ì£¼ì„¸ìš” (ìµœëŒ€ 1,000ì)"></textarea>
                <button onclick="submitVote()" class="submit-btn" id="submit-btn">í‰ì  ë° ì½”ë©˜íŠ¸ ì „ì†¡</button>
            </div>

            <div id="review-list"></div>
            
            <div id="load-more-container" style="text-align:center; margin:35px 0;">
                <button class="load-more-btn" style="padding:14px 40px; border-radius:50px; border:1.5px solid #ddd; background:#fff; cursor:pointer; font-weight:800; color:#777;" onclick="loadMore()">ë¦¬ë·° 10ê°œ ë”ë³´ê¸°</button>
            </div>

            <div style="margin-top:50px; border-top:1.5px solid #eee; padding-top:40px;">
                <h3 style="font-size:1.2rem; font-weight:900;"><i class="fa-solid fa-fire" style="color:var(--main-color);"></i> ì¡°íšŒìˆ˜ ê¸‰ìƒìŠ¹ ë ˆì´ìŠ¤</h3>
                <div class="related-grid" id="related-list" style="display:grid; grid-template-columns: repeat(2, 1fr); gap:15px; margin-top:20px;"></div>
            </div>
        </div>
    </div>

    <script>
        const _supabase = supabase.createClient(CONFIG.SUPABASE_URL, CONFIG.SUPABASE_KEY);
        const urlParams = new URLSearchParams(window.location.search);
        const raceId = urlParams.get('id');

        let offset = 0;
        let bestIds = [];

        function getScoreColorClass(score) {
            if (score <= 3) return 'bg-red';
            if (score <= 6) return 'bg-orange';
            return 'bg-green';
        }

        // 2. ì„¼ìŠ¤ìˆëŠ” ë‹‰ë„¤ì„ + ìˆ«ì 6ìë¦¬ ë””í´íŠ¸ ìƒì„±
        function setNickname() {
            const prefixes = ["ë‚ ìœ¼ëŠ”", "ë‚­ë§Œì ì¸", "ë²ˆê°œê°™ì€", "ì™„ì£¼í•˜ëŠ”", "ì¶¤ì¶”ëŠ”", "ë‹¬ë¦¬ëŠ”", "ì§€ì¹˜ì§€ì•ŠëŠ”"];
            const nouns = ["ì†Œë‹‰", "ì¹˜íƒ€", "ê±°ë¶ì´", "ëŸ¬ë„ˆ", "ìš”ì •", "ì—”ì§„", "ë°œë°”ë‹¥"];
            const nick = prefixes[Math.floor(Math.random()*prefixes.length)] + nouns[Math.floor(Math.random()*nouns.length)];
            const num = Math.floor(100000 + Math.random() * 900000);
            document.getElementById('v-author').value = nick + num;
        }

        const ids = ['v-course', 'v-management', 'v-supplies', 'v-souvenirs', 'v-cost_effective'];
        ids.forEach(id => {
            const el = document.getElementById(id);
            for(let i=10; i>=1; i--) {
                const opt = document.createElement('option');
                opt.value = i; opt.innerText = i + 'ì ';
                el.appendChild(opt);
            }
        });

        async function init() {
            if (!raceId) return;
            try {
                setNickname(); // ë‹‰ë„¤ì„ ìƒì„±
                await _supabase.rpc('increment_views', { r_id: raceId });

                const { data: race } = await _supabase.from('schedules').select('*').eq('id', raceId).single();
                document.getElementById('race-title').innerText = race.title;
                document.getElementById('admin-desc').innerText = race.description || 'ëŒ€íšŒ ì •ë³´ê°€ ê³§ ì—…ë°ì´íŠ¸ ë©ë‹ˆë‹¤.';
                if (race.video_url) document.getElementById('youtube-player').src = `https://www.youtube.com/embed/${race.video_url}`;

                const { data: all } = await _supabase.from('reviews').select('*').eq('race_id', raceId);
                if (all && all.length > 0) {
                    const avg = (all.reduce((s, r) => s + (r.course+r.management+r.supplies+r.souvenirs+r.cost_effective), 0) / (all.length * 5)).toFixed(1);
                    document.getElementById('user-val').innerText = avg;
                    document.getElementById('user-avg-badge').className = `badge-circle ${getScoreColorClass(avg)}`;
                    document.getElementById('user-count').innerText = `${all.length}ëª…ì˜ ëŸ¬ë„ˆê°€ ë°ì´í„°ë¥¼ ì œê³µí•¨`;

                    const valids = all.filter(r => !(r.reports >= 5 && r.reports > (r.likes || 0)));
                    const sortedBests = valids.sort((a,b) => (b.likes || 0) - (a.likes || 0)).slice(0, 3);
                    bestIds = sortedBests.map(b => b.id);
                    renderBestComments(sortedBests);
                }

                await loadMore();
                loadRelatedRaces();

                document.getElementById('status-view').style.display = 'none';
                document.getElementById('main-view').style.display = 'block';
            } catch (err) { console.error(err); }
        }

        function renderBestComments(data) {
            const area = document.getElementById('best-comments-area');
            if(data.length === 0) return area.style.display = 'none';
            area.innerHTML = data.map(r => {
                const avg = ((r.course+r.management+r.supplies+r.souvenirs+r.cost_effective)/5).toFixed(1);
                const cleanText = r.comment.trim();
                const isLong = cleanText.length > 60;
                return `
                <div class="best-mini-item">
                    <span class="best-tag"><i class="fa-solid fa-crown"></i> BEST</span> <b>${avg}ì </b>
                    <span id="best-txt-${r.id}">${isLong ? cleanText.substring(0, 60) + '...' : cleanText}</span>
                    ${isLong ? `<span style="color:var(--main-color); font-weight:800; cursor:pointer; margin-left:5px;" onclick="this.parentElement.querySelector('#best-txt-${r.id}').innerText='${cleanText.replace(/'/g, "\\'")}'; this.remove();">ë‚´ìš© ë”ë³´ê¸°</span>` : ''}
                </div>`;
            }).join('');
        }

        async function loadMore() {
            const { data } = await _supabase.from('reviews').select('*').eq('race_id', raceId)
                .order('created_at', { ascending: false }).range(offset, offset + 9);
            if (data) {
                const list = document.getElementById('review-list');
                list.insertAdjacentHTML('beforeend', data.filter(r => !bestIds.includes(r.id)).map(r => createReviewItem(r)).join(''));
                offset += 10;
                if(data.length < 10) document.getElementById('load-more-container').style.display = 'none';
            }
        }

        function createReviewItem(r) {
            const avg = ((r.course+r.management+r.supplies+r.souvenirs+r.cost_effective)/5).toFixed(1);
            const isBlinded = (r.reports >= 5 && r.reports > (r.likes || 0));
            // 12. ê³µë°± ì œê±° (trim ë° ì—°ì† ê³µë°± ë°©ì§€)
            const cleanComment = r.comment ? r.comment.trim().replace(/\n{3,}/g, '\n\n') : 'ì½”ë©˜íŠ¸ ì—†ìŒ';

            return `
            <div class="review-item" id="rev-${r.id}">
                <div style="display:flex; justify-content:space-between; font-size:0.85rem; color:#999; margin-bottom:10px;">
                    <span style="font-weight:900; color:#333;">ğŸ‘¤ ${r.author_name} <span class="badge-circle ${getScoreColorClass(avg)}" style="width:40px; height:25px; border-radius:8px; font-size:0.75rem; display:inline-flex; vertical-align:middle; margin-left:8px; color:#fff;">${avg}</span></span>
                    <span>${new Date(r.created_at).toLocaleDateString()}</span>
                </div>
                ${!isBlinded ? `
                    <div style="display:flex; gap:5px; margin-bottom:12px; flex-wrap:wrap;">
                        <span class="score-tag">ğŸ—ºï¸ ì½”ìŠ¤ ${r.course}</span><span class="score-tag">ğŸ”§ ìš´ì˜ ${r.management}</span>
                        <span class="score-tag">ğŸ¥› ë³´ê¸‰ ${r.supplies}</span><span class="score-tag">ğŸ‘• ê¸°ë…í’ˆ ${r.souvenirs}</span>
                        <span class="score-tag">ğŸ’° ê°€ì„±ë¹„ ${r.cost_effective}</span>
                    </div>
                    <div class="review-text">${cleanComment}</div>
                ` : '<p style="color:#bbb; font-style:italic;">ë¸”ë¼ì¸ë“œ ëœ ë¦¬ë·°ì…ë‹ˆë‹¤.</p>'}
                <div class="interaction-bar">
                    <button class="inter-btn" onclick="handleLike('${r.id}', ${r.likes || 0})"><i class="fa-regular fa-thumbs-up"></i> ${r.likes || 0}</button>
                    <button class="inter-btn" onclick="handleReport('${r.id}', ${r.reports || 0})"><i class="fa-solid fa-flag"></i> ì‹ ê³ </button>
                    <div class="review-actions" style="margin-left:auto; display:flex; gap:12px; color:#ccc;">
                        <span style="cursor:pointer;" onclick="handleEdit('${r.id}')">ìˆ˜ì •</span>
                        <span style="cursor:pointer;" onclick="handleDelete('${r.id}')">ì‚­ì œ</span>
                    </div>
                </div>
            </div>`;
        }

        async function handleLike(id, cur) { await _supabase.from('reviews').update({ likes: cur+1 }).eq('id', id); location.reload(); }
        async function handleReport(id, cur) { if(!confirm("ì‹ ê³ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return; await _supabase.from('reviews').update({ reports: cur+1 }).eq('id', id); alert("ì‹ ê³  ì™„ë£Œ"); location.reload(); }
        
        // 4. ì•”í˜¸ë¥¼ ì´ìš©í•œ ì‚­ì œ ë° ìˆ˜ì •
        async function handleDelete(id) { 
            const pw = prompt("ì‘ì„± ì‹œ ì„¤ì •í•œ ì•”í˜¸ 6ìë¦¬ë¥¼ ì…ë ¥í•˜ì„¸ìš”."); 
            const { data } = await _supabase.from('reviews').delete().eq('id', id).eq('password', pw).select();
            if(data && data.length > 0) { alert("ì„±ê³µì ìœ¼ë¡œ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤."); location.reload(); } 
            else alert("ì•”í˜¸ê°€ í‹€ë ¸ê±°ë‚˜ ì‚­ì œí•  ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.");
        }

        async function handleEdit(id) {
            const pw = prompt("ì‘ì„± ì‹œ ì„¤ì •í•œ ì•”í˜¸ 6ìë¦¬ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
            const { data: currentReview } = await _supabase.from('reviews').select('*').eq('id', id).eq('password', pw).single();
            if(currentReview) {
                const newComment = prompt("ìƒˆë¡œìš´ ì½”ë©˜íŠ¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.", currentReview.comment);
                if(newComment) {
                    await _supabase.from('reviews').update({ comment: newComment.trim() }).eq('id', id);
                    alert("ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤."); location.reload();
                }
            } else alert("ì•”í˜¸ê°€ í‹€ë ¸ê±°ë‚˜ ìˆ˜ì •í•  ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.");
        }

        async function loadRelatedRaces() {
            const { data } = await _supabase.from('schedules').select('*').neq('id', raceId)
                .gte('race_date', new Date().toISOString().split('T')[0])
                .order('views', { ascending: false }).limit(4);
            if (data) {
                document.getElementById('related-list').innerHTML = data.map(r => `
                    <div class="rel-card" onclick="location.href='race_detail.html?id=${r.id}'">
                        <img src="${r.poster_url || 'https://via.placeholder.com/400x300'}" style="width:100%; height:120px; object-fit:cover;">
                        <div style="padding:10px; font-size:0.85rem; font-weight:800; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${r.title}</div>
                    </div>`).join('');
            }
        }

        async function submitVote() {
            const pw = document.getElementById('v-pw').value;
            const comment = document.getElementById('v-comment').value.trim();
            if (pw.length !== 6) return alert("ì•”í˜¸ 6ìë¦¬ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            if (!comment) return alert("ì½”ë©˜íŠ¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");

            const payload = {
                race_id: raceId, course: parseInt(document.getElementById('v-course').value),
                management: parseInt(document.getElementById('v-management').value),
                supplies: parseInt(document.getElementById('v-supplies').value),
                souvenirs: parseInt(document.getElementById('v-souvenirs').value),
                cost_effective: parseInt(document.getElementById('v-cost_effective').value),
                author_name: document.getElementById('v-author').value,
                password: pw, comment: comment
            };
            const { error } = await _supabase.from('reviews').insert([payload]);
            if (!error) location.reload();
            else alert("ì „ì†¡ ì‹¤íŒ¨: " + error.message);
        }

        window.onload = init;
    </script>
</body>
</html>